# Lovefield Design Document
## SPAC

SPAC means Schema Parser and Code Generator. As the name suggested, there are
two sub-components in SPAC: the Parser, and the Code Generator.

### Schema Parser (`spac/parser.js`)
The YAML parsing is handled via nodejs js-yaml module. The module will simply
pass back a JS object. For example:

```yaml
%YAML 1.2
---
name: crdb
version: 1
table:
  ImageCache:
    column:
      remote: string
      local: string
      remote: integer  # Duplicate that would be ignored
    constraint:
      primaryKey: [ remote ]
```

There is a duplicate field in column definition. For SPAC's current usage of
js-yaml, the `remote` attribute passed to parser will be `integer` without
errors (i.e. the last one wins). What the parser does is to perform some basic
sanity checks for the returned schema object:

* Check required fields within a schema item definition exists
* Check the type of a property is expected
* Check name collisions (i.e. field name collides with reserved words)

The parser is best described as *best-effort*. Please
[file bugs](https://github.com/google/lovefield/issues) if you found there are
critical issues to be addressed.

### Code Generator (`spac/codegen.js`)

Code generator reads a template file (say, `template/database.jstemplate`) and
convert it into &lt;escaped namespace&gt;_&lt;template name&gt;.js
(say, lovefield_db_database.js). The template expansion is simple macro
expansion. All macros start with the `#` sign, which is an invalid character
for JavaScript so that we can easily detect errors if the macros inside
template are not fully expanded.

#### Simple Macros

The following table lists the simple macros supported by current code generator:

| Macro         | Expands to                               |
|---------------|------------------------------------------|
| `bundledmode` | The `pragma bundledMode` value in schema |
| `dbname`      | Database name specified in schema        |
| `dbtablelist` | List of table names in schema            |
| `dbversion`   | Database version specified in schema     |
| `namespace`   | Namespace given to SPAC                  |


#### Scope Directives

Scope directives start with `/// #` to instruct the code generator that this is
the beginning/end of a scope block and the code generator shall honor it.

| Macro             | Expands to                                               |
|-------------------|----------------------------------------------------------|
| `repeattable`     | Begin of repeat table block, affects all `#table` macros.|
| `repeattableend`  | End of repeat table block.                               |
| `repeatcolumn`    | Begin of repeat column block, must be nested inside repeattable. |
| `repeatcolumnend` | End of repeat column block.                              |
| `sort`            | Begin of a sort block, contents inside sort block will be sorted in lexical order.|
| `sortend`         | End of a sort block.                                     |


#### Repeating Macros

Repeating macros must live in their repeating scope, otherwise they will not
expand correctly.

| Macro              | Scope          | Expands to                        |
|--------------------|----------------|-----------------------------------|
| `table`            | `repeattable`  | The tables in schema.             |
| `tablename`        | `repeattable`  | The table names.                  |
| `column`           | `repeatcolumn` | The columns in table.             |
| `columnjstype`     | `repeatcolumn` | Actual JavaScript type of column. |
| `columntype`       | `repeatcolumn` | The type of column.               |
| `columnuniqueness` | `repeatcolumn` | The uniqueness of column.         |


#### Suffixing Macros

Suffixing macros formats the expanded content of macro that is suffixed.

| Macro    | Expands to                    |
|----------|-------------------------------|
| `camel`  | Camel style, e.g. singleCamel |
| `pascal` | Pascal style, e.g. DualCamel  |


#### Complex Macros

These macros directly generate JavaScript code and therefore it is necessary to
change contents inside `spac/codegen.js` if the contents generated by these
macros need to change. All complex macros are repeating macros, they must live
within `repeattable` scope.

| Macro              | Expands to                                 |
|--------------------|--------------------------------------------|
|`deserializerow`    |`<Table>.prototype.deserializeRow`          |
|`getdefaultpayload` |`row.<Table>.prototype.defaultPayload`      |
|`keyofindex`        |`row.<Table>.prototype.keyOfIndex`          |
|`rowpropgetset`     |Getters and setters of columns for each row.|
|`tablecontraint`    |`<Table>.prototype.getConstraint`           |
|`tablecolumntypes`  |`<Table>.prototype.<TableType>`             |
|`tablecolumndbtypes`|`<Table>.prototype.<TableDbType>`           |
|`tableindices`      |`<Table>.prototype.getIndices`              |
|`todbpayload`       |`row.<Table>.prototype.toDbPayload`         |
